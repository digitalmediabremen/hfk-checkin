{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}
{% block extrahead %}
    {{ block.super }}
    {{ select_resource_form.media }}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.css' rel='stylesheet'/>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.5.1/main.min.css' rel='stylesheet'/>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.5.1/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/locales/de.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.5.1/locales/de.js'></script>
    <script>
        var resource_uuids = ['{{ uuid|default:original.resource.uuid }}'];
        var resource_extraParams = function() {
            return { resources: resource_uuids.join('.') }
        };
        var last_added_resource = null;
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'resourceTimelineDay',
                schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
                headerToolbar: {
                    start: 'title',
                    center: '',
                    end: 'today prev,next resourceTimelineDay,resourceTimelineWeek,resourceTimelineMonth,resourceTimelineYear'
                },
                height: 400,
                initialDate: '{{ original.begin|date:"c" }}',
                eventSources: [{
                    url: '/api/calendar/event/',
                    method: 'GET',
                    extraParams: resource_extraParams,
                    failure: function() {
                        resource_uuids.pop(last_added_resource);
                        last_added_resource = null;
                        calendar.addResource({
                            title: "Nicht gefunden",
                            id: "NOT_FOUND"
                        });
                        setTimeout(() => {
                            calendar.getResourceById('NOT_FOUND').remove()
                        }, 2000);
                      },
                    success: function(){
                        calendar.refetchResources()
                    }
                },[
                    {
                    start: '{{ original.begin|date:"c" }}',
                    end: '{{ original.end|date:"c" }}',
                    display: 'background'
                    }
                ]],
                {#resources: '/api/calendar/resource/',#}
                resources: {
                    url: '/api/calendar/resource/',
                    method: 'GET',
                    extraParams: resource_extraParams,
                },
                resourceOrder: 'index,title,id',
                resourceGroupField: 'unit_name',
                resourceAreaColumns: [
                {
                    field: 'name',
                    headerContent: 'Space',
                },
                {
                    field: 'display_numbers',
                    headerContent: 'Number',
                    width: "30%",
                },
                {
                    field: 'capacity',
                    headerContent: 'Cap.',
                    width: "20%",
                }
                ],
                locale: 'de',
                weekNumbers: true,
                nowIndicator: true,
                businessHours: {
                  // days of week. an array of zero-based day of week integers (0=Sunday)
                  daysOfWeek: [ 1, 2, 3, 4, 5 ], // Monday - Thursday
                  startTime: '10:00', // a start time (10am in this example)
                  endTime: '20:00', // an end time (6pm in this example)
                },
                eventColor: 'var(--theme-color-primary)',
            });
            calendar.render();
            django.jQuery(document.querySelector('#id_resource')).on('change', (event) => {
                var uuid = event.target.value;
                if (uuid && !resource_uuids.includes(uuid)) {
                    resource_uuids.push(uuid);
                    last_added_resource = uuid;
                    calendar.refetchEvents();
                }
            });
        });
    </script>
{% endblock %}

{#{% block header %}#}
{% block breadcrumbs %}
    <div style="padding: 20px 40px"id='calendar'></div>
    <hr/>
    {{ block.super }}
{% endblock %}

{#{% block nav-sidebar %}#}
{#    {{ block.super }}#}
{#{% endblock %}#}

{#{% block messages %}#}
{#    {{ block.super }}#}
{#    {% if not is_popup %}#}
{#        <hr/>#}
{#        <div style="padding: 20px 40px"id='calendar'></div>#}
{#        <hr/>#}
{#    {% endif %}#}
{#{% endblock messages %}#}

{#{% block field_sets %}#}
{#    {% calendar_template-tag %}#}
{#{{ block.super }}#}
{#{% endblock %}#}